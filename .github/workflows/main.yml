
name: CI (Gitleaks → Maven Verify → Sonar via Maven)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  ci:
    runs-on: self-hosted  # or your labels

    steps:
      - name: Checkout (full history for scanners)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java 17 (Temurin) + Maven cache
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Gitleaks scan (fail on leaks)
        uses: gitleaks/gitleaks-action@v2
        # env: { GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} }  # only if you want PR comments

      # Build with tests so Sonar "sees" bytecode and reports
      - name: Build & test (Maven)
        run: mvn -B -ntp clean verify

      # Sonar analysis via Maven plugin; wait for Quality Gate -> fail pipeline if not passed
      - name: SonarQube via Maven (Quality Gate)
        run: mvn -B -ntp sonar:sonar -Dsonar.qualitygate.wait=true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      # (Optional) Package again, or proceed to next stages if gate passed
      - name: Package
        run: mvn -B -ntp package -DskipTests
